# Trading Bot Configuration

trading:
  mode: "paper"  # paper or live
  symbols:
    - AAPL
    - MSFT
    - GOOGL
    - AMZN
    - NVDA
    - META
    - TSLA

  # Market hours (Eastern Time)
  market_open: "09:30"
  market_close: "16:00"

  # Trading frequency
  check_interval_seconds: 60

risk_management:
  # Position limits
  max_position_pct: 0.10          # 10% max per position
  max_positions: 20               # Maximum number of positions

  # Daily limits
  max_daily_loss_pct: 0.05        # 5% daily loss limit
  max_daily_trades: 50            # Maximum trades per day
  pause_after_consecutive_losses: 3

  # Exposure limits
  max_total_exposure: 0.80        # 80% max invested
  max_sector_exposure: 0.30       # 30% max per sector

  # Stop loss settings
  stop_loss:
    default_type: "atr"           # fixed, atr, or trailing
    fixed_pct: 0.05               # 5% for fixed stops
    atr_multiplier: 2.0           # 2x ATR for ATR-based stops
    trailing_pct: 0.03            # 3% trailing stop

  # Take profit settings (with multiple levels for partial exits)
  take_profit:
    enabled: true
    levels:                        # Multiple TP levels: [target_pct, exit_pct]
      - [0.05, 0.33]              # TP1: 5% gain, sell 33% of position
      - [0.10, 0.50]              # TP2: 10% gain, sell 50% of remaining
      - [0.15, 1.0]               # TP3: 15% gain, sell everything left

  # VIX-based position sizing
  volatility_sizing:
    enabled: true
    vix_thresholds:
      low: 15                     # VIX < 15: calm market
      normal: 25                  # VIX 15-25: normal volatility
      high: 35                    # VIX 25-35: high volatility
      extreme: 50                 # VIX > 35: extreme volatility
    size_multipliers:
      low: 1.2                    # Increase size in calm markets
      normal: 1.0                 # Normal sizing
      high: 0.7                   # Reduce size in high vol
      extreme: 0.5                # Half size in extreme vol

  # Max drawdown protection
  drawdown_protection:
    enabled: true
    max_drawdown_pct: 0.10        # 10% max portfolio drawdown
    recovery_threshold: 0.95      # Exit recovery at 95% of peak
    recovery_size_multiplier: 0.5 # 50% position size in recovery mode

  # Market regime detection
  regime_detection:
    enabled: true
    vix_volatile_threshold: 30    # VIX level for volatile regime
    adx_trend_threshold: 25       # ADX level for trending market
    adx_choppy_threshold: 20      # ADX level below which market is choppy
    cache_hours: 4                # Hours to cache regime detection
    regime_parameters:
      bull:
        stop_loss_pct: 0.05
        position_size_multiplier: 1.0
        min_confidence: 0.50      # Lowered from 0.55
      bear:
        stop_loss_pct: 0.03
        position_size_multiplier: 0.7
        min_confidence: 0.55      # Lowered from 0.60
      choppy:
        stop_loss_pct: 0.02
        position_size_multiplier: 0.5
        min_confidence: 0.58      # Lowered from 0.70 (was blocking most trades!)
      volatile:
        stop_loss_pct: 0.08
        position_size_multiplier: 0.5
        min_confidence: 0.55      # Lowered from 0.65

ml_model:
  # Model selection
  primary_model: "xgboost"        # xgboost, lstm, cnn, or ensemble

  # Prediction settings
  prediction_horizon: 5           # Days ahead to predict
  confidence_threshold: 0.55      # Minimum confidence to trade (lowered from 0.60)
  min_confidence_sell: 0.50       # Minimum confidence for SELL signal (lowered from 0.55)

  # Training settings
  train_window_days: 252          # 1 year of training data
  retrain_frequency_days: 30      # Retrain every 30 days
  sequence_length: 20             # Sequence length for LSTM/CNN

  # Ensemble settings (if primary_model is "ensemble")
  ensemble:
    voting_method: "soft"         # hard, soft, or weighted
    weights:
      xgboost: 1.0                # XGBoost weight
      lstm: 0.8                   # LSTM weight
      cnn: 0.8                    # CNN weight
    models:
      xgboost: "trading_model"
      lstm: "lstm_trading_model"
      cnn: "cnn_trading_model"

  # Feature settings
  technical_indicators:
    - sma_20
    - sma_50
    - ema_12
    - ema_26
    - rsi_14
    - macd
    - macd_signal
    - bollinger_upper
    - bollinger_lower
    - atr_14
    - obv
    - vwap

backtesting:
  initial_capital: 100000
  commission: 0.0                 # WeBull is commission-free
  slippage_pct: 0.001            # 0.1% slippage assumption

  # Walk-forward settings
  train_period_days: 252          # 1 year training
  test_period_days: 63            # 3 months testing
  step_days: 21                   # 1 month step

notifications:
  enabled: true
  channels:
    - telegram
    - discord

  # Event types to notify
  notify_on:
    trade_executed: true
    stop_loss_triggered: true
    take_profit_triggered: true
    daily_summary: true
    risk_warning: true
    system_error: true

dashboard:
  port: 8501
  refresh_interval_seconds: 30
  theme: "dark"

retraining:
  enabled: true
  schedule: "daily"               # weekly, daily, or monthly
  day_of_week: "sun"              # For weekly: mon, tue, wed, thu, fri, sat, sun
  hour: 2                         # Hour to run (0-23, in local time)
  auto_deploy: true               # Auto-deploy if model improves
  min_improvement: 0.01           # Minimum accuracy improvement (1%) to deploy
  notify_on_complete: true        # Log results when complete

  # Phase 18: Degradation Detection
  degradation_detection:
    enabled: false                    # Opt-in: monitor production model health
    check_interval_hours: 12          # How often to check for degradation
    evaluation_window_days: 63        # Data window for evaluation (3 months)
    n_eval_windows: 3                 # Walk-forward windows for evaluation
    accuracy_drop_threshold: 0.05     # 5% accuracy drop triggers alert
    confidence_collapse_threshold: 0.55  # Avg probability below this = collapse
    sharpe_decline_threshold: -0.5    # Sharpe below this = degraded
    min_win_rate: 0.40                # Win rate below 40% = problematic

  # Phase 18: Auto-Rollback
  auto_rollback:
    enabled: false                    # Opt-in: rollback bad deployments
    grace_period_days: 5              # Days to monitor after deployment
    check_frequency_hours: 24         # How often to check during grace period

  # Phase 18: Walk-Forward Validation
  walk_forward_validation:
    enabled: false                    # Opt-in: validate before deploy
    n_windows: 3                      # Walk-forward windows for validation
    min_sharpe: 0.0                   # Minimum Sharpe to pass
    min_profit_factor: 1.0            # Minimum profit factor to pass
    max_drawdown: 0.25                # Maximum drawdown allowed (25%)
    comparison_weights:               # Multi-metric comparison weights
      sharpe_ratio: 0.35
      profit_factor: 0.25
      accuracy: 0.20
      max_drawdown: 0.20

sentiment:
  enabled: true
  provider: "bluesky"             # bluesky, finnhub, alpha_vantage
  analyzer: "finbert"             # finbert (local NLP on MPS GPU)
  cache_hours: 4                  # Hours to cache sentiment data
  articles_per_symbol: 50         # Number of articles to fetch per symbol
  features:
    - sentiment_score
    - sentiment_ma5
    - sentiment_volatility
    - article_count
    - sentiment_momentum
    - sentiment_dispersion
    - positive_ratio
    - news_intensity

# Phase 20: Portfolio Optimization
portfolio_optimization:
  enabled: true                   # Enable portfolio optimization (Phase 20)

  # Optimization method
  method: "max_sharpe"            # max_sharpe, risk_parity, minimum_variance, equal_weight, mean_variance

  # Historical data parameters
  lookback_days: 252              # 1 year of returns for optimization (more stable estimates)
  min_history_days: 60            # Minimum required history

  # Weight constraints
  min_weight: 0.05                # Minimum 5% per asset (avoid tiny positions)
  max_weight: 0.30                # Maximum 30% per asset (allow concentration when justified)

  # Risk parameters
  risk_free_rate: 0.05            # 5% annual risk-free rate (for Sharpe calculation)
  correlation_threshold: 0.70     # Warn if asset correlation > 0.7
  max_cluster_exposure: 0.50      # Maximum 50% exposure to correlated asset cluster

  # ML signal integration
  incorporate_signals: true       # Tilt weights based on ML trading signals
  signal_tilt_strength: 0.15      # Maximum 15% weight tilt based on signal confidence

  # Rebalancing settings
  rebalancing:
    enabled: true                 # Enable automatic rebalancing
    trigger_type: "threshold"     # Changed from "combined" - now triggers on drift alone

    # Threshold-based rebalancing
    drift_threshold: 0.08         # Rebalance if any weight drifts > 8% from target (lowered from 10%)

    # Calendar-based rebalancing
    frequency: "weekly"           # Changed from monthly to weekly for more activity

    # Trade filtering
    min_trade_value: 100.0        # Minimum $100 per trade (lowered from $200)
    max_trades_per_rebalance: 10  # Maximum 10 trades per rebalancing event (increased from 8)

    # Transaction costs
    slippage_pct: 0.001           # 0.1% slippage assumption

  # Advanced settings (optional)
  covariance_method: "ledoit_wolf"  # ledoit_wolf, sample, or exponential
  cache_ttl_hours: 4                # Cache correlation matrices for 4 hours

  # Phase 21: Regime-Aware Optimization
  regime_aware: true                # Automatically adapt optimization method to market regime
                                     # BULL → Max Sharpe, BEAR → Min Variance
                                     # CHOPPY → Risk Parity, VOLATILE → Min Variance + cash buffer

# Performance Reporting
reporting:
  # Daily reports
  daily:
    enabled: true                   # Generate daily performance reports
    time: "17:00"                   # Report time (24-hour format, market close + 1 hour)

  # Weekly reports
  weekly:
    enabled: true                   # Generate weekly performance reports
    day: "monday"                   # Day of week (monday, tuesday, etc.)
    time: "09:00"                   # Report time (24-hour format)

  # Monthly reports
  monthly:
    enabled: false                  # Generate monthly performance reports
    day: 1                          # Day of month (1-31)
    time: "09:00"                   # Report time (24-hour format)

  # Delivery methods
  send_email: true                  # Send reports via email
  send_discord: true                # Send reports via Discord
  save_to_file: true                # Save reports to data/reports/ directory

  # Email configuration (set in .env file)
  # SMTP_SERVER=smtp.gmail.com
  # SMTP_PORT=587
  # SENDER_EMAIL=your_email@gmail.com
  # SENDER_PASSWORD=your_app_password
  # RECIPIENT_EMAILS=recipient1@example.com,recipient2@example.com
